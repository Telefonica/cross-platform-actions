name: Citadel Login
description: Login into Citadel execution platform services
inputs:
  citadel-registries:
    required: false
    description: Registries manifest. Available as secrets.CITADEL_REGISTRIES

runs:
  using: composite
  steps:
    - name: Mask Secrets
      uses: actions/github-script@v6
      with:
        script: |
          const registriesInput = core.getInput('citadel-registries') || '{}';

          try {
            const registries = JSON.parse(registriesInput);
            if (registries.oci?.dev?.password){
              core.setSecret(registries.oci.dev.password);
            }
            if (registries.oci?.pro?.password){
              core.setSecret(registries.oci.pro.password);
            }
          }

    - name: Login to OCI dev registry
      uses: docker/login-action@v2
      if: fromJSON(inputs.citadel-registries).oci.dev
      with:
        registry: ${{ fromJSON(inputs.citadel-registries).oci.dev.registry }}
        username: ${{ fromJSON(inputs.citadel-registries).oci.dev.username }}
        password: ${{ fromJSON(inputs.citadel-registries).oci.dev.password }}

    - name: Login to OCI pro registry
      uses: docker/login-action@v2
      if: fromJSON(inputs.citadel-registries).oci.pro
      with:
        registry: ${{ fromJSON(inputs.citadel-registries).oci.pro.registry }}
        username: ${{ fromJSON(inputs.citadel-registries).oci.pro.username }}
        password: ${{ fromJSON(inputs.citadel-registries).oci.pro.password }}
